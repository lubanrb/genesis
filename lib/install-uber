#!/usr/bin/env bash

# ==========
# Uber Setup
# ==========

bundle_gems() {
  print_step "Bundle required gems"

  cd $WORK_DIR/uber
  
  if $LUBBASE_BIN/bundle check > /dev/null
  then
    print_line "Bundle gems setup is skipped: bundled ALREADY"
  else
    print_line "Bundle installing gems"
    $LUBBASE_BIN/bundle package >> $RUBY_INST_LOG_FILE 2>&1
    $LUBBASE_BIN/gem install --force --no-document --local vendor/cache/*.gem >> $RUBY_INST_LOG_FILE 2>&1
    create_gems_binstubs
  fi
  cd $WORK_DIR
}

print_summary() {  
  print_step
  print_step "** ATTENTION **"
  print_step "Run commands below to COMPLETE the Uber setup:"
  print_line "cd uber"
  print_line "$LUBBASE_BIN/luban $UBER_STAGE lubbase setup"
  print_step
  print_step "** NOTE **"
  print_step "To activate Uber in the current shell session:"
  print_line "source $LUBBASE_ROOT/.luban_profile"
  print_step
  print_step "Also, Uber will be activated for new shell sessions by default."
  print_step "If this is not desired, remove the activation code in ~/.bashrc"
}

setup_uber() {
  print_task "Setup Uber"
  if [ ! -d "$WORK_DIR/uber" ]; then
    mv /tmp/uber-master $WORK_DIR/uber
  fi

  bundle_gems
  print_summary
}